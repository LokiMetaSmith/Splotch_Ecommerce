
> lokimetasmith.github.io@1.0.0 test:unit
> node --experimental-vm-modules node_modules/jest/bin/jest.js --forceExit

(node:6184) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
PASS tests/pricing.test.js
PASS tests/webauthn.test.js
(node:6183) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
PASS tests/image.test.js
PASS tests/xss-patch.test.js
(node:6182) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
PASS tests/orders.test.js (6.738 s)
  ‚óè Console

    console.log
      [KEY_MANAGER] Rotating keys...

      at rotateKeys (server/keyManager.js:38:13)

    console.log
      [KEY_MANAGER] Now managing 1 active keys.

      at rotateKeys (server/keyManager.js:44:13)

    console.log
      [dotenv@17.2.1] injecting env (0) from server/.env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

      at _log (node_modules/dotenv/lib/main.js:139:11)

    console.log
      [SERVER] Pricing configuration loaded.

      at server/server.js:76:13

    console.log
      [SERVER] LowDB database initialized at: /app/server/test-db-orders.json

      at startServer (server/server.js:157:13)

    console.log
      [SERVER] Multer configured for file uploads.

      at startServer (server/server.js:181:13)

    console.log
      [SERVER] Initializing Square client...

      at startServer (server/server.js:184:13)

    console.log
      [SERVER] Using injected Square client.

      at startServer (server/server.js:202:15)

    console.log
      [SERVER] Square client initialized.

      at startServer (server/server.js:220:13)

    console.log
      [SERVER] Performing sanity check on Square client...

      at startServer (server/server.js:222:13)

    console.log
      ‚úÖ [SERVER] Sanity check passed. Client has required API properties.

      at startServer (server/server.js:228:13)

    console.warn
      ‚ö†Ô∏è [SECURITY] CSRF_SECRET is not set or is weak. Using a default for development.

      290 |             // but we should log a clear warning.
      291 |             csrfSecret = weakDefaultCsrfSecret;
    > 292 |             console.warn('‚ö†Ô∏è [SECURITY] CSRF_SECRET is not set or is weak. Using a default for development.');
          |                     ^
      293 |             console.warn('   Do not use this configuration in production.');
      294 |         }
      295 |     } else {

      at startServer (server/server.js:292:21)
      at Object.<anonymous> (tests/orders.test.js:79:30)

    console.warn
         Do not use this configuration in production.

      291 |             csrfSecret = weakDefaultCsrfSecret;
      292 |             console.warn('‚ö†Ô∏è [SECURITY] CSRF_SECRET is not set or is weak. Using a default for development.');
    > 293 |             console.warn('   Do not use this configuration in production.');
          |                     ^
      294 |         }
      295 |     } else {
      296 |         console.log('‚úÖ [SERVER] Custom CSRF_SECRET is set.');

      at startServer (server/server.js:293:21)
      at Object.<anonymous> (tests/orders.test.js:79:30)

    console.log
      [SERVER] Middleware (CORS, JSON, static file serving) enabled.

      at startServer (server/server.js:324:13)

    console.warn
      [TRACKER] EASYPOST_API_KEY is not set. Shipment tracker is disabled.

      12 |         console.log('[TRACKER] EasyPost shipment tracker initialized.');
      13 |     } else {
    > 14 |         console.warn('[TRACKER] EASYPOST_API_KEY is not set. Shipment tracker is disabled.');
         |                 ^
      15 |     }
      16 | }
      17 |

      at initializeTracker (server/tracker.js:14:17)
      at startServer (server/server.js:1160:5)
      at Object.<anonymous> (tests/orders.test.js:79:30)

    console.log
      [KEY_MANAGER] Rotating keys...

      at rotateKeys (server/keyManager.js:38:13)

    console.log
      [KEY_MANAGER] Now managing 2 active keys.

      at rotateKeys (server/keyManager.js:44:13)

    console.log
      [SERVER] Signed new session token with key ID: 31ad00d73c69555a

      at signInstanceToken (server/server.js:95:13)

    console.log
      [CLIENT INSPECTION] Keys on squareClient: [ 'locations', 'payments' ]

      at server/server.js:460:17

    console.log
      [SERVER] Square payment successful. Payment ID: payment_123

      at server/server.js:466:17

    console.log
      [SERVER] New order created and stored. Order ID: ca964e37-e291-4f47-b63c-3cdd4751d2fc.

      at server/server.js:482:17

    console.log
      [CLIENT INSPECTION] Keys on squareClient: [ 'locations', 'payments' ]

      at server/server.js:460:17

    console.error
      [Critical error in /api/create-order] Error: Card declined
          at Object.<anonymous> (/app/tests/orders.test.js:56:39)
          at /app/node_modules/jest-environment-node/node_modules/jest-mock/build/index.js:305:39
          at Object.<anonymous> (/app/node_modules/jest-environment-node/node_modules/jest-mock/build/index.js:312:13)
          at Object.mockConstructor [as create] (/app/node_modules/jest-environment-node/node_modules/jest-mock/build/index.js:102:19)
          at /app/server/server.js:461:59
          at Layer.handleRequest (/app/node_modules/router/lib/layer.js:152:17)
          at next (/app/node_modules/router/lib/route.js:157:13)
          at middleware (/app/node_modules/express-validator/lib/middlewares/check.js:16:13)
          at processTicksAndRejections (node:internal/process/task_queues:105:5) {
        statusCode: 400,
        result: { errors: [ [Object] ] }
      }

      118 |     fs.appendFileSync(path.join(__dirname, 'error.log'), sanitizedErrorMessage);
      119 |     // The full error (including stack) is still logged to the console for debugging.
    > 120 |     console.error(`[${context}]`, error);
          |             ^
      121 |     if (process.env.ADMIN_EMAIL && oauth2Client.credentials.access_token) {
      122 |       try {
      123 |         await sendEmail({

      at logAndEmailError (server/server.js:120:13)
      at server/server.js:539:15

    console.log
      [SERVER] Order ID order_4 status updated to PRINTING.

      at server/server.js:633:15

    console.log
      [SERVER] Tracking info added to order ID order_5.

      at server/server.js:708:17

    console.log
      [SERVER] Shipment notification email sent for order ID order_5.

      at server/server.js:765:25

PASS server/auth.test.js (6.71 s)
  ‚óè Console

    console.log
      [KEY_MANAGER] Rotating keys...

      at rotateKeys (server/keyManager.js:38:13)

    console.log
      [KEY_MANAGER] Now managing 1 active keys.

      at rotateKeys (server/keyManager.js:44:13)

    console.log
      [dotenv@17.2.1] injecting env (0) from server/.env -- tip: üì° auto-backup env with Radar: https://dotenvx.com/radar

      at _log (node_modules/dotenv/lib/main.js:139:11)

    console.log
      [SERVER] Pricing configuration loaded.

      at server/server.js:76:13

    console.log
      [SERVER] LowDB database initialized at: /app/server/test-db.json

      at startServer (server/server.js:157:13)

    console.log
      [SERVER] Multer configured for file uploads.

      at startServer (server/server.js:181:13)

    console.log
      [SERVER] Initializing Square client...

      at startServer (server/server.js:184:13)

    console.error
      [SERVER] FATAL: SQUARE_ACCESS_TOKEN is not set in environment variables.

      187 |     if (!squareClient) {
      188 |       if (!process.env.SQUARE_ACCESS_TOKEN) {
    > 189 |         console.error('[SERVER] FATAL: SQUARE_ACCESS_TOKEN is not set in environment variables.');
          |                 ^
      190 |         // In a test environment, we don't want to kill the test runner.
      191 |         if (process.env.NODE_ENV !== 'test') {
      192 |           process.exit(1);

      at startServer (server/server.js:189:17)
      at Object.<anonymous> (server/auth.test.js:23:26)

    console.log
      [SERVER] Verifying connection to Square servers...

      at startServer (server/server.js:200:15)

    console.log
      [SERVER] Square client initialized.

      at startServer (server/server.js:220:13)

    console.log
      [SERVER] Performing sanity check on Square client...

      at startServer (server/server.js:222:13)

    console.log
      ‚úÖ [SERVER] Sanity check passed. Client has required API properties.

      at startServer (server/server.js:228:13)

    console.warn
      ‚ö†Ô∏è [SECURITY] CSRF_SECRET is not set or is weak. Using a default for development.

      290 |             // but we should log a clear warning.
      291 |             csrfSecret = weakDefaultCsrfSecret;
    > 292 |             console.warn('‚ö†Ô∏è [SECURITY] CSRF_SECRET is not set or is weak. Using a default for development.');
          |                     ^
      293 |             console.warn('   Do not use this configuration in production.');
      294 |         }
      295 |     } else {

      at startServer (server/server.js:292:21)
      at Object.<anonymous> (server/auth.test.js:23:26)

    console.warn
         Do not use this configuration in production.

      291 |             csrfSecret = weakDefaultCsrfSecret;
      292 |             console.warn('‚ö†Ô∏è [SECURITY] CSRF_SECRET is not set or is weak. Using a default for development.');
    > 293 |             console.warn('   Do not use this configuration in production.');
          |                     ^
      294 |         }
      295 |     } else {
      296 |         console.log('‚úÖ [SERVER] Custom CSRF_SECRET is set.');

      at startServer (server/server.js:293:21)
      at Object.<anonymous> (server/auth.test.js:23:26)

    console.log
      [SERVER] Middleware (CORS, JSON, static file serving) enabled.

      at startServer (server/server.js:324:13)

    console.warn
      [TRACKER] EASYPOST_API_KEY is not set. Shipment tracker is disabled.

      12 |         console.log('[TRACKER] EasyPost shipment tracker initialized.');
      13 |     } else {
    > 14 |         console.warn('[TRACKER] EASYPOST_API_KEY is not set. Shipment tracker is disabled.');
         |                 ^
      15 |     }
      16 | }
      17 |

      at initializeTracker (server/tracker.js:14:17)
      at startServer (server/server.js:1160:5)
      at Object.<anonymous> (server/auth.test.js:23:26)

    console.log
      [KEY_MANAGER] Rotating keys...

      at rotateKeys (server/keyManager.js:38:13)

    console.log
      [KEY_MANAGER] Now managing 2 active keys.

      at rotateKeys (server/keyManager.js:44:13)

    console.log
      [SERVER] Signed new session token with key ID: 5f8d4cdaced63f88

      at signInstanceToken (server/server.js:95:13)

    console.log
      New user created for WebAuthn pre-registration: testuser

      at server/server.js:1057:17

PASS server/tests/form-data-exploit.test.js (6.737 s)
  ‚óè Console

    console.log
      [KEY_MANAGER] Rotating keys...

      at rotateKeys (server/keyManager.js:38:13)

    console.log
      [KEY_MANAGER] Now managing 1 active keys.

      at rotateKeys (server/keyManager.js:44:13)

    console.log
      [dotenv@17.2.1] injecting env (0) from server/.env -- tip: üì° auto-backup env with Radar: https://dotenvx.com/radar

      at _log (node_modules/dotenv/lib/main.js:139:11)

    console.log
      [SERVER] Pricing configuration loaded.

      at server/server.js:76:13

    console.log
      [SERVER] LowDB database initialized at: /app/server/tests/test-db.json

      at startServer (server/server.js:157:13)

    console.log
      [SERVER] Multer configured for file uploads.

      at startServer (server/server.js:181:13)

    console.log
      [SERVER] Initializing Square client...

      at startServer (server/server.js:184:13)

    console.error
      [SERVER] FATAL: SQUARE_ACCESS_TOKEN is not set in environment variables.

      187 |     if (!squareClient) {
      188 |       if (!process.env.SQUARE_ACCESS_TOKEN) {
    > 189 |         console.error('[SERVER] FATAL: SQUARE_ACCESS_TOKEN is not set in environment variables.');
          |                 ^
      190 |         // In a test environment, we don't want to kill the test runner.
      191 |         if (process.env.NODE_ENV !== 'test') {
      192 |           process.exit(1);

      at startServer (server/server.js:189:17)
      at Object.<anonymous> (server/tests/form-data-exploit.test.js:39:25)

    console.log
      [SERVER] Verifying connection to Square servers...

      at startServer (server/server.js:200:15)

    console.log
      [SERVER] Square client initialized.

      at startServer (server/server.js:220:13)

    console.log
      [SERVER] Performing sanity check on Square client...

      at startServer (server/server.js:222:13)

    console.log
      ‚úÖ [SERVER] Sanity check passed. Client has required API properties.

      at startServer (server/server.js:228:13)

    console.warn
      ‚ö†Ô∏è [SECURITY] CSRF_SECRET is not set or is weak. Using a default for development.

      290 |             // but we should log a clear warning.
      291 |             csrfSecret = weakDefaultCsrfSecret;
    > 292 |             console.warn('‚ö†Ô∏è [SECURITY] CSRF_SECRET is not set or is weak. Using a default for development.');
          |                     ^
      293 |             console.warn('   Do not use this configuration in production.');
      294 |         }
      295 |     } else {

      at startServer (server/server.js:292:21)
      at Object.<anonymous> (server/tests/form-data-exploit.test.js:39:25)

    console.warn
         Do not use this configuration in production.

      291 |             csrfSecret = weakDefaultCsrfSecret;
      292 |             console.warn('‚ö†Ô∏è [SECURITY] CSRF_SECRET is not set or is weak. Using a default for development.');
    > 293 |             console.warn('   Do not use this configuration in production.');
          |                     ^
      294 |         }
      295 |     } else {
      296 |         console.log('‚úÖ [SERVER] Custom CSRF_SECRET is set.');

      at startServer (server/server.js:293:21)
      at Object.<anonymous> (server/tests/form-data-exploit.test.js:39:25)

    console.log
      [SERVER] Middleware (CORS, JSON, static file serving) enabled.

      at startServer (server/server.js:324:13)

    console.warn
      [TRACKER] EASYPOST_API_KEY is not set. Shipment tracker is disabled.

      12 |         console.log('[TRACKER] EasyPost shipment tracker initialized.');
      13 |     } else {
    > 14 |         console.warn('[TRACKER] EASYPOST_API_KEY is not set. Shipment tracker is disabled.');
         |                 ^
      15 |     }
      16 | }
      17 |

      at initializeTracker (server/tracker.js:14:17)
      at startServer (server/server.js:1160:5)
      at Object.<anonymous> (server/tests/form-data-exploit.test.js:39:25)

    console.log
      [KEY_MANAGER] Rotating keys...

      at rotateKeys (server/keyManager.js:38:13)

    console.log
      [KEY_MANAGER] Now managing 2 active keys.

      at rotateKeys (server/keyManager.js:44:13)

    console.log
      [SERVER] Signed new session token with key ID: 9dce98fd2810e448

      at signInstanceToken (server/server.js:95:13)

PASS tests/server.test.js
  ‚óè Console

    console.log
      [KEY_MANAGER] Rotating keys...

      at rotateKeys (server/keyManager.js:38:13)

    console.log
      [KEY_MANAGER] Now managing 1 active keys.

      at rotateKeys (server/keyManager.js:44:13)

    console.log
      [dotenv@17.2.1] injecting env (0) from server/.env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

      at _log (node_modules/dotenv/lib/main.js:139:11)

    console.log
      [SERVER] Pricing configuration loaded.

      at server/server.js:76:13

    console.warn
      [TELEGRAM] Bot token not found. Bot is disabled.

      160 |
      161 |   } else {
    > 162 |     console.warn('[TELEGRAM] Bot token not found. Bot is disabled.');
          |             ^
      163 |     // Create a mock bot to avoid errors when the token is not set
      164 |     bot = {
      165 |       telegram: {

      at initializeBot (server/bot.js:162:13)
      at Object.<anonymous> (tests/server.test.js:23:15)

    console.log
      [SERVER] LowDB database initialized at: /app/tests/test-db.json

      at startServer (server/server.js:157:13)

    console.log
      [SERVER] Multer configured for file uploads.

      at startServer (server/server.js:181:13)

    console.log
      [SERVER] Initializing Square client...

      at startServer (server/server.js:184:13)

    console.error
      [SERVER] FATAL: SQUARE_ACCESS_TOKEN is not set in environment variables.

      187 |     if (!squareClient) {
      188 |       if (!process.env.SQUARE_ACCESS_TOKEN) {
    > 189 |         console.error('[SERVER] FATAL: SQUARE_ACCESS_TOKEN is not set in environment variables.');
          |                 ^
      190 |         // In a test environment, we don't want to kill the test runner.
      191 |         if (process.env.NODE_ENV !== 'test') {
      192 |           process.exit(1);

      at startServer (server/server.js:189:17)
      at Object.<anonymous> (tests/server.test.js:25:30)

    console.log
      [SERVER] Verifying connection to Square servers...

      at startServer (server/server.js:200:15)

    console.log
      [SERVER] Square client initialized.

      at startServer (server/server.js:220:13)

    console.log
      [SERVER] Performing sanity check on Square client...

      at startServer (server/server.js:222:13)

    console.log
      ‚úÖ [SERVER] Sanity check passed. Client has required API properties.

      at startServer (server/server.js:228:13)

    console.warn
      ‚ö†Ô∏è [SECURITY] CSRF_SECRET is not set or is weak. Using a default for development.

      290 |             // but we should log a clear warning.
      291 |             csrfSecret = weakDefaultCsrfSecret;
    > 292 |             console.warn('‚ö†Ô∏è [SECURITY] CSRF_SECRET is not set or is weak. Using a default for development.');
          |                     ^
      293 |             console.warn('   Do not use this configuration in production.');
      294 |         }
      295 |     } else {

      at startServer (server/server.js:292:21)
      at Object.<anonymous> (tests/server.test.js:25:30)

    console.warn
         Do not use this configuration in production.

      291 |             csrfSecret = weakDefaultCsrfSecret;
      292 |             console.warn('‚ö†Ô∏è [SECURITY] CSRF_SECRET is not set or is weak. Using a default for development.');
    > 293 |             console.warn('   Do not use this configuration in production.');
          |                     ^
      294 |         }
      295 |     } else {
      296 |         console.log('‚úÖ [SERVER] Custom CSRF_SECRET is set.');

      at startServer (server/server.js:293:21)
      at Object.<anonymous> (tests/server.test.js:25:30)

    console.log
      [SERVER] Middleware (CORS, JSON, static file serving) enabled.

      at startServer (server/server.js:324:13)

    console.warn
      [TRACKER] EASYPOST_API_KEY is not set. Shipment tracker is disabled.

      12 |         console.log('[TRACKER] EasyPost shipment tracker initialized.');
      13 |     } else {
    > 14 |         console.warn('[TRACKER] EASYPOST_API_KEY is not set. Shipment tracker is disabled.');
         |                 ^
      15 |     }
      16 | }
      17 |

      at initializeTracker (server/tracker.js:14:17)
      at startServer (server/server.js:1160:5)
      at Object.<anonymous> (tests/server.test.js:25:30)

    console.log
      [KEY_MANAGER] Rotating keys...

      at rotateKeys (server/keyManager.js:38:13)

    console.log
      [KEY_MANAGER] Now managing 2 active keys.

      at rotateKeys (server/keyManager.js:44:13)

    console.log
      [SERVER] Signed new session token with key ID: 47fe8b204e0227b9

      at signInstanceToken (server/server.js:95:13)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.

Test Suites: 8 passed, 8 total
Tests:       47 passed, 47 total
Snapshots:   0 total
Time:        11.641 s
Ran all test suites.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
