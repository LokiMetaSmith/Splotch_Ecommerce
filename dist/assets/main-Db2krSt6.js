import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css               *//* empty css                      */import{S as we}from"./svgparser-CkglikQg.js";const ce="sandbox-sq0idb-tawTw_Vl7VGYI6CZfKEshA",de="LTS82DEX24XR0",A="http://localhost:3000";let ue,ge,M,g=null,c,s,T=[],C=[],E=!1,F=[],u=null,y=null,_=!1,Q=!1,oe,ie,ae,U,se,N,x,q,P,$,L,Z,j,te,H,X,Y,J,D=0;async function xe(){if(c=document.getElementById("imageCanvas"),!c){console.error("FATAL: imageCanvas element not found. Aborting BootStrap.");const i=document.querySelector("body");if(i){const n=document.createElement("div");n.textContent="Critical error: Image canvas not found. Please refresh or contact support.",n.style.color="red",n.style.padding="20px",n.style.textAlign="center",i.prepend(n)}return}s=c.getContext("2d",{willReadFrequently:!0}),oe=document.getElementById("textInput"),ie=document.getElementById("textSizeInput"),ae=document.getElementById("textColorInput"),U=document.getElementById("addTextBtn"),se=document.getElementById("textFontFamily"),N=document.getElementById("stickerMaterial"),x=document.getElementById("stickerResolution"),q=document.getElementById("designMarginNote"),P=document.getElementById("stickerQuantity"),$=document.getElementById("calculatedPriceDisplay"),L=document.getElementById("payment-status-container"),document.getElementById("ipfsLinkContainer"),Z=document.getElementById("file"),te=document.getElementById("fileNameDisplay"),j=document.getElementById("payment-form"),H=document.getElementById("rotateLeftBtn"),X=document.getElementById("rotateRightBtn");const t=document.getElementById("resizeSlider"),e=document.getElementById("resizeValue");Y=document.getElementById("grayscaleBtn"),J=document.getElementById("sepiaBtn"),await Promise.all([K(),ke()]),console.log(`[CLIENT] Initializing Square SDK with appId: ${ce}, locationId: ${de}`);try{if(!window.Square||!window.Square.payments)throw new Error("Square SDK is not loaded.");ue=window.Square.payments(ce,de),ge=await ve(ue)}catch(i){m(`Failed to initialize payments: ${i.message}`,"error"),console.error("[CLIENT] Failed to initialize Square payments SDK:",i);return}P&&(v(),P.addEventListener("input",v),P.addEventListener("change",v)),N&&N.addEventListener("change",v),x&&x.addEventListener("change",v),U&&U.addEventListener("click",Fe),H&&H.addEventListener("click",()=>he(-90)),X&&X.addEventListener("click",()=>he(90)),Y&&Y.addEventListener("click",De),J&&J.addEventListener("click",Ne),t&&t.addEventListener("input",i=>{let n=parseFloat(i.target.value);E?(e&&(e.textContent=`${n.toFixed(1)} mm`),ee(n/25.4)):(e&&(e.textContent=`${n.toFixed(1)} in`),ee(n))});const r=document.getElementById("generateCutlineBtn");r&&r.addEventListener("click",ze);const o=document.getElementById("standard-sizes-controls");o&&o.addEventListener("click",i=>{if(i.target.classList.contains("size-btn")){const n=parseFloat(i.target.dataset.size);ee(n);const l=document.getElementById("resizeSlider"),d=document.getElementById("resizeValue");l&&d&&(E?(l.value=n*25.4,d.textContent=`${(n*25.4).toFixed(1)} mm`):(l.value=n,d.textContent=`${n.toFixed(1)} in`))}});const a=document.getElementById("unitToggle");a&&a.addEventListener("change",i=>{E=i.target.checked,Le(E),(g||C.length>0)&&(v(),O())}),Z&&Z.addEventListener("change",Pe),c&&(c.addEventListener("dragover",i=>{i.preventDefault(),c.classList.add("border-dashed","border-2","border-blue-500")}),c.addEventListener("dragleave",i=>{i.preventDefault(),c.classList.remove("border-dashed","border-2","border-blue-500")}),c.addEventListener("drop",i=>{i.preventDefault(),c.classList.remove("border-dashed","border-2","border-blue-500");const n=i.dataTransfer.files[0];n&&ne(n)})),window.addEventListener("paste",i=>{const n=(i.clipboardData||i.originalEvent.clipboardData).items;for(const l of n)if(l.kind==="file"){const d=l.getAsFile();d&&ne(d)}}),console.log("[CLIENT] BootStrap: Checking paymentFormGlobalRef before attaching listener. paymentFormGlobalRef:",j),j?(console.log("[CLIENT] BootStrap: paymentFormGlobalRef found. Attaching submit event listener."),j.addEventListener("submit",Te)):(console.error("[CLIENT] BootStrap: Payment form with ID 'payment-form' not found. Payments will not work."),m("Payment form is missing. Cannot process payments.","error")),le(!g),q&&(q.style.display="none")}document.addEventListener("DOMContentLoaded",()=>{xe(),setTimeout(()=>{typeof Square>"u"&&(console.error("[CLIENT] Square SDK appears to be blocked."),Ie())},2e3)});function Ie(){const t=document.getElementById("adblock-warning");t&&(t.style.display="block")}function Ee(t){let e=0;const r=(o,a)=>Math.sqrt(Math.pow(a.x-o.x,2)+Math.pow(a.y-o.y,2));return t.forEach(o=>{for(let a=0;a<o.length;a++){const i=o[a],n=o[(a+1)%o.length];e+=r(i,n)}}),e}function Ce(t,e,r,o,a){if(!y)return console.error("Pricing config not loaded."),{total:0,complexityMultiplier:1};if(t<=0)return{total:0,complexityMultiplier:1};if(!r||r.width<=0||r.height<=0)return{total:0,complexityMultiplier:1};if(!a)return{total:0,complexityMultiplier:1};const i=a.ppi,l=r.width/i*(r.height/i)*y.pricePerSquareInchCents,d=y.materials.find(I=>I.id===e),p=d?d.costMultiplier:1,h=Ee(o)/i;let w=1;const b=[...y.complexity.tiers].sort((I,W)=>I.thresholdInches==="Infinity"?1:W.thresholdInches==="Infinity"?-1:I.thresholdInches-W.thresholdInches);for(const I of b)if(h<=I.thresholdInches){w=I.multiplier;break}let S=0;const k=[...y.quantityDiscounts].sort((I,W)=>W.quantity-I.quantity);for(const I of k)if(t>=I.quantity){S=I.discount;break}const R=a.costMultiplier,B=l*t*p*w*R*(1-S);return{total:Math.round(B),complexityMultiplier:w}}function v(){if(!y||!P||!$||!x)return;const t=N.value,e=x.value,r=y.resolutions.find(h=>h.id===e),o=parseInt(P.value,10),a=u,i=F;if(isNaN(o)||o<0){D=0,$.textContent=o<0?"Invalid Quantity":me(0);return}if(!a||!i||!r){D=0,$.innerHTML='Price: <span class="text-gray-500">---</span>';return}const n=Ce(o,t,a,i,r);D=n.total;const l=r.ppi;let d=a.width/l,p=a.height/l,f="in";E&&(d*=25.4,p*=25.4,f="mm"),$.innerHTML=`
        <span class="font-bold text-lg">${me(D)}</span>
        <span class="text-sm text-gray-600 block">
            Size: ${d.toFixed(1)}${f} x ${p.toFixed(1)}${f}
        </span>
        <span class="text-xs text-gray-500 block">
            Complexity Modifier: x${n.complexityMultiplier}
        </span>
    `}function me(t){return(t/100).toLocaleString("en-US",{style:"currency",currency:"USD"})}async function ve(t){if(!t)throw new Error("Payments SDK not ready for card initialization.");const e=await t.card();return await e.attach("#card-container"),e}async function be(t,e){if(!t)throw new Error("Card payment method not initialized.");const r=await t.tokenize(e);if(r.status==="OK"){if(!r.token)throw new Error("Tokenization succeeded but no token was returned.");return r.token}let o=`Tokenization failed: ${r.status}`;throw r.errors&&(o+=` ${JSON.stringify(r.errors)}`),new Error(o)}function Se(){!y||!x||(x.innerHTML="",y.resolutions.forEach(t=>{const e=document.createElement("option");e.value=t.id,e.textContent=t.name,x.appendChild(e)}),x.value="dpi_300")}async function ke(){try{const t=await fetch(`${A}/api/pricing-info`);if(!t.ok)throw new Error(`Server responded with ${t.status}`);y=await t.json(),console.log("[CLIENT] Pricing config loaded:",y),Se()}catch(t){console.error("[CLIENT] Error fetching pricing info:",t),m("Could not load pricing information. Please refresh.","error")}}async function K(){try{const t=await fetch(`${A}/api/csrf-token`,{credentials:"include"});if(!t.ok)throw new Error(`Server responded with ${t.status}`);const e=await t.json();if(!e.csrfToken)throw new Error("CSRF token not found in server response");M=e.csrfToken,console.log("[CLIENT] CSRF Token fetched and stored.")}catch(t){console.error("[CLIENT] Error fetching CSRF token:",t),m("A security token could not be loaded. Please refresh the page to continue.","error")}}async function Te(t){if(console.log("[CLIENT] handlePaymentFormSubmit triggered."),t.preventDefault(),m("Processing order...","info"),!g){m("Please upload a sticker design image before submitting.","error");return}if(!M){m("Cannot submit form. A required security token is missing. Please refresh the page.","error"),console.error("[CLIENT] Aborting submission: CSRF token is missing.");return}const e=document.getElementById("email").value;if(!e){m("Please enter an email address to proceed.","error");return}try{m("Issuing temporary auth token...","info");const r=await fetch(`${A}/api/auth/issue-temp-token`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,_csrf:M})});if(!r.ok){const B=await r.json().catch(()=>({}));if(B.error&&B.error.includes("csrf")){console.warn("[CLIENT] CSRF token was invalid during auth token issuance. Fetching a new one."),await K(),m("Your session expired. It has been refreshed. Please try submitting again.","error");return}throw new Error(`Could not issue a temporary authentication token. Server responded with: ${B.error||r.statusText}`)}const{token:o}=await r.json();if(!o)throw new Error("Temporary authentication token was not received.");if(console.log("[CLIENT] Temporary auth token received."),await K(),!M)throw new Error("Could not retrieve a new security token for file upload.");const a=await new Promise(B=>c.toBlob(B,"image/png"));if(!a)throw new Error("Could not get image data from canvas.");m("Uploading design...","info");const i=new FormData;i.append("designImage",a,"design.png"),i.append("_csrf",M);const n=document.getElementById("cutLineFile");n&&n.files[0]&&i.append("cutLineFile",n.files[0]);const l=await fetch(`${A}/api/upload-design`,{method:"POST",credentials:"include",headers:{Authorization:`Bearer ${o}`,"X-CSRF-Token":M},body:i}),d=await l.json();if(!l.ok)throw new Error(d.error||"Failed to upload design.");const p=d.designImagePath,f=d.cutLinePath;console.log("[CLIENT] Design uploaded. Path:",p),f&&console.log("[CLIENT] Cut line uploaded. Path:",f);const h={givenName:document.getElementById("firstName").value,familyName:document.getElementById("lastName").value,email:document.getElementById("email").value,phone:document.getElementById("phone").value,addressLines:[document.getElementById("address").value],city:document.getElementById("city").value,state:document.getElementById("state").value,postalCode:document.getElementById("postalCode").value,countryCode:"US"},w={amount:(D/100).toFixed(2),currencyCode:"USD",intent:"CHARGE",billingContact:h,customerInitiated:!0,sellerKeyedIn:!1};m("Securing card details...","info"),console.log("[CLIENT] Tokenizing card with verification details.");const b=await be(ge,w);console.log("[CLIENT] Tokenization successful. Nonce (sourceId):",b);const S={quantity:P?parseInt(P.value,10):0,material:N?N.value:"unknown",cutLinePath:f},k={sourceId:b,amountCents:D,currency:"USD",designImagePath:p,orderDetails:S,billingContact:h,_csrf:M};m("Submitting order to server...","info"),console.log("[CLIENT] Submitting order to server at /api/create-order");const R=await fetch(`${A}/api/create-order`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify(k)}),z=await R.json();if(!R.ok)throw z.error&&z.error.includes("csrf")&&(m("Your security token has expired. Please try submitting again.","error"),console.warn("[CLIENT] CSRF token was invalid. Fetching a new one."),await K()),new Error(z.error||"Failed to create order on server.");console.log("[CLIENT] Order created successfully on server:",z),m("Order successfully placed! Redirecting to your order history...","success"),setTimeout(()=>{window.location.href=`/orders.html?token=${o}`},2e3)}catch(r){console.error("[CLIENT] Error during payment form submission:",r),m(`Error: ${r.message}`,"error")}}function m(t,e="info"){if(!L){console.error("Payment status container not found. Message:",t);return}L.textContent=t,L.style.visibility="visible",L.classList.remove("payment-success","payment-error","payment-info"),e==="success"?L.classList.add("payment-success"):e==="error"?L.classList.add("payment-error"):L.classList.add("payment-info")}function Le(t){const r=document.querySelectorAll(".size-btn"),o=document.getElementById("resizeSlider"),a=document.getElementById("resizeValue"),i=document.getElementById("designMarginNote");if(r.forEach(n=>{const l=parseFloat(n.dataset.size);t?n.textContent=`${(l*25.4).toFixed(0)}mm`:n.textContent=`${l}"`}),o&&a){let n=parseFloat(o.value);t?(o.dataset.originalMin||(o.dataset.originalMin=o.min,o.dataset.originalMax=o.max,o.dataset.originalStep=o.step),o.min=o.dataset.originalMin*25.4,o.max=o.dataset.originalMax*25.4,o.step=o.dataset.originalStep*25.4/10,o.value=n*25.4,a.textContent=`${(n*25.4).toFixed(1)} mm`):o.dataset.originalMin&&(o.min=o.dataset.originalMin,o.max=o.dataset.originalMax,o.step=o.dataset.originalStep,o.value=n/25.4,a.textContent=`${(n/25.4).toFixed(1)} in`)}i&&(t?i.textContent="Keep important elements 2-3mm from edge!":i.textContent="Keep important elements 0.08-0.12in from edge!")}function le(t){const e=[H,X,Y,J,document.getElementById("resizeSlider"),document.getElementById("generateCutlineBtn"),oe,ie,ae,U,se],r=["opacity-50","cursor-not-allowed"];e.forEach(o=>{o&&(o.disabled=t,t?o.classList.add(...r):o.classList.remove(...r))}),q&&(q.style.display=t?"none":"block")}function Pe(t){const e=t.target.files[0];e&&ne(e)}function ne(t){if(!t)return;te&&(te.textContent=t.name);const e=new FileReader;t.type==="image/svg+xml"?(g=null,e.onload=r=>{Be(r.target.result)},e.onerror=()=>m("Error reading SVG file.","error"),e.readAsText(t)):t.type.startsWith("image/")?(C=[],T=[],F=[],e.onload=()=>{const r=new Image;r.onload=()=>{g=r,le(!1),m("Image loaded successfully.","success");const o=500,a=400;let i=r.width,n=r.height;if(i>o){const l=o/i;i=o,n*=l}if(n>a){const l=a/n;n=a,i*=l}c&&s&&(c.width=i,c.height=n,s.clearRect(0,0,c.width,c.height),s.drawImage(g,0,0,c.width,c.height),u={left:0,top:0,right:i,bottom:n,width:i,height:n},F=[[{x:0,y:0},{x:i,y:0},{x:i,y:n},{x:0,y:n}]],C=[],v(),G(u),V(u))},r.onerror=()=>m("Error loading image data.","error"),r.src=e.result},e.onerror=()=>m("Error reading file.","error"),e.readAsDataURL(t)):m("Invalid file type. Please select an image or SVG file.","error")}function O(){if(C.length===0)return;const t=pe(C,10);if(F=t,u=ClipperLib.JS.BoundsOfPaths(t),!u||u.right-u.left<=0||u.bottom-u.top<=0){console.error("Invalid bounds calculated, aborting redraw.",u);return}c.width=u.right-u.left+40,c.height=u.bottom-u.top+40,s.clearRect(0,0,c.width,c.height);const e={x:-u.left+20,y:-u.top+20};fe(C,"black",e),fe(F,"red",e,!0),G(u,e),V(u,e),Me(u,e),v()}function Be(t){const e=new we;try{e.load(t),e.cleanInput();const r=[];if(e.svgRoot.querySelectorAll("path, rect, circle, ellipse, polygon, polyline").forEach(n=>{const l=e.polygonify(n);l&&l.length>0&&r.push(l)}),r.length===0)throw new Error("No parsable shapes found in the SVG.");const a=pe(r,10);T=r,C=r,F=a,u=ClipperLib.JS.BoundsOfPaths(a),c.width=u.right-u.left+40,c.height=u.bottom-u.top+40;const i={x:-u.left+20,y:-u.top+20};O(),m("SVG processed and cutline generated.","success"),le(!1)}catch(r){m(`SVG Processing Error: ${r.message}`,"error"),console.error(r)}}function pe(t,e){const o=t.map(l=>l.map(d=>({X:d.x*100,Y:d.y*100}))),a=new ClipperLib.ClipperOffset,i=new ClipperLib.Paths;return a.AddPaths(o,ClipperLib.JoinType.jtRound,ClipperLib.EndType.etClosedPolygon),a.Execute(i,e*100),i.map(l=>l.map(d=>({x:d.X/100,y:d.Y/100})))}function fe(t,e,r={x:0,y:0},o=!1){s&&t.forEach(a=>{if(a.length!==0){s.beginPath(),s.moveTo(a[0].x+r.x,a[0].y+r.y);for(let i=1;i<a.length;i++)s.lineTo(a[i].x+r.x,a[i].y+r.y);s.closePath(),o?(s.strokeStyle=e,s.lineWidth=1,s.setLineDash([4,4]),s.stroke(),s.setLineDash([])):(s.fillStyle=e,s.fill())}})}function G(t,e={x:0,y:0}){!s||!t||!y||(s.strokeStyle="rgba(128, 128, 128, 0.9)",s.lineWidth=2,s.setLineDash([10,5]),s.strokeRect(t.left+e.x,t.top+e.y,t.width,t.height),s.setLineDash([]))}function V(t,e={x:0,y:0}){var n;if(!s||!t||!y||!x)return;const r=((n=y.resolutions.find(l=>l.id===x.value))==null?void 0:n.ppi)||96;let o=t.width/r,a=t.height/r,i="in";E&&(o*=25.4,a*=25.4,i="mm"),s.fillStyle="rgba(0, 0, 0, 0.75)",s.font="14px Arial",s.textAlign="center",s.textBaseline="bottom",s.fillText(`${o.toFixed(1)} ${i}`,e.x+t.width/2,e.y-10),s.textAlign="right",s.textBaseline="middle",s.save(),s.translate(e.x-10,e.y+t.height/2),s.rotate(-Math.PI/2),s.fillText(`${a.toFixed(1)} ${i}`,0,0),s.restore()}function Me(t,e={x:0,y:0}){var i;if(!s||!t||!y||!x)return;const r=((i=y.resolutions.find(n=>n.id===x.value))==null?void 0:i.ppi)||96,o=E?10*r/25.4:r,a=E?o/10:o/8;s.save(),s.strokeStyle="rgba(0, 0, 0, 0.5)",s.fillStyle="rgba(0, 0, 0, 0.8)",s.font="10px Arial",s.lineWidth=1;for(let n=0;n*a<=t.width;n++){const l=e.x+n*a,d=e.y-10,p=n%(E?10:8)===0,f=p?10:5;if(s.beginPath(),s.moveTo(l,d),s.lineTo(l,d+f),s.stroke(),p&&n>0){const h=E?n/10:n/8;s.fillText(h,l-3,d-2)}}for(let n=0;n*a<=t.height;n++){const l=e.y+n*a,d=e.x-10,p=n%(E?10:8)===0,f=p?10:5;if(s.beginPath(),s.moveTo(d,l),s.lineTo(d+f,l),s.stroke(),p&&n>0){const h=E?n/10:n/8;s.fillText(h,d-12,l+3)}}s.restore()}function Fe(){if(!c||!s||!g){m("Please load an image before adding text.","error");return}const t=oe.value,e=parseInt(ie.value,10),r=ae.value,o=se.value;if(!t.trim()||isNaN(e)||e<=0){m("Please enter valid text and size.","error");return}s.font=`${e}px ${o}`,s.fillStyle=r,s.textAlign="center",s.textBaseline="middle",s.fillText(t,c.width/2,c.height/2),m(`Text "${t}" added.`,"success")}function he(t){if(T.length>0){const e=ClipperLib.JS.BoundsOfPaths(C),r=e.left+(e.right-e.left)/2,o=e.top+(e.bottom-e.top)/2,a=t*Math.PI/180,i=Math.cos(a),n=Math.sin(a);C=C.map(l=>l.map(d=>{const p=d.x-r,f=d.y-o,h=p*i-f*n,w=p*n+f*i;return{x:h+r,y:w+o}})),O()}else if(g){const e=c.width,r=c.height,o=t===90||t===-90?r:e,a=t===90||t===-90?e:r,i=document.createElement("canvas"),n=i.getContext("2d");i.width=o,i.height=a,n.translate(o/2,a/2),n.rotate(t*Math.PI/180),n.drawImage(c,-e/2,-r/2),c.width=o,c.height=a,s.clearRect(0,0,o,a),s.drawImage(i,0,0),u={left:0,top:0,right:o,bottom:a,width:o,height:a},v(),G(u),V(u)}}function ye(){if(!(!g||!s||!c)){if(s.clearRect(0,0,c.width,c.height),s.drawImage(g,0,0,c.width,c.height),_){const t=s.getImageData(0,0,c.width,c.height),e=t.data;for(let r=0;r<e.length;r+=4){const o=(e[r]+e[r+1]+e[r+2])/3;e[r]=o,e[r+1]=o,e[r+2]=o}s.putImageData(t,0,0)}else if(Q){const t=s.getImageData(0,0,c.width,c.height),e=t.data;for(let r=0;r<e.length;r+=4){const o=e[r],a=e[r+1],i=e[r+2];e[r]=Math.min(255,o*.393+a*.769+i*.189),e[r+1]=Math.min(255,o*.349+a*.686+i*.168),e[r+2]=Math.min(255,o*.272+a*.534+i*.131)}s.putImageData(t,0,0)}u&&(G(u),V(u))}}function De(){if(!c||!s||!g)return;_=!_,Q=!1,ye()}function Ne(){if(!c||!s||!g)return;Q=!Q,_=!1,ye()}function ee(t){if(!y||!g&&T.length===0){m("Please load an image first.","error");return}const e=y.resolutions.find(n=>n.id===x.value);if(!e)return;const r=e.ppi,o=t*r;let a;if(T.length>0){const n=ClipperLib.JS.BoundsOfPaths(T);a=Math.max(n.width,n.height)}else a=Math.max(g.width,g.height);if(a<=0)return;const i=o/a;if(T.length>0)C=T.map(n=>n.map(l=>({x:l.x*i,y:l.y*i}))),O();else if(g){const n=g.width*i,l=g.height*i;n>0&&l>0&&(c.width=n,c.height=l,s.clearRect(0,0,c.width,c.height),s.drawImage(g,0,0,n,l),u={left:0,top:0,right:n,bottom:l,width:n,height:l},F=[[{x:0,y:0},{x:n,y:0},{x:n,y:l},{x:0,y:l}]],v(),G(u),V(u))}}function Re(){if(!c||!s)return!1;const t=s.getImageData(0,0,c.width,c.height),{data:e,width:r,height:o}=t,a=10,i=n=>e[n+3]<128||e[n]>250&&e[n+1]>250&&e[n+2]>250;for(let n=0;n<r;n+=Math.floor(r/a))if(!i((0*r+n)*4)||!i(((o-1)*r+n)*4))return!1;for(let n=0;n<o;n+=Math.floor(o/a))if(!i((n*r+0)*4)||!i((n*r+(r-1))*4))return!1;return!0}function ze(){if(!c||!s||!g){m("Smart cutline requires a raster image (PNG, JPG). Please upload one.","error");return}if(!Re()&&!confirm("This image does not appear to have a transparent or white background. The 'Smart Cutline' feature may not produce a good result. Proceed anyway?"))return;m("Generating smart cutline...","info");const t=s.getImageData(0,0,c.width,c.height);setTimeout(()=>{try{const e=s.getImageData(0,0,c.width,c.height),r=$e(e);if(!r||r.length<3)throw new Error("Could not find a distinct contour. Image may be empty or too complex.");const o=qe(r,2),a=100,i=o.map(d=>({X:d.x*a,Y:d.y*a})),n=ClipperLib.Clipper.CleanPolygon(i,1.415);if(!n||n.length<3)throw new Error("Could not detect a usable outline. Try an image with a transparent background.");const l=n.map(d=>({x:d.X/a,y:d.Y/a}));T=[l],C=[l],O(),m("Smart cutline generated successfully.","success")}catch(e){s.putImageData(t,0,0),m(`Error: ${e.message}`,"error"),console.error(e)}},50)}function $e(t){const{data:e,width:r,height:o}=t,a=(f,h)=>{if(f<0||f>=r||h<0||h>=o)return!1;const w=(h*r+f)*4,b=e[w],S=e[w+1],k=e[w+2];return!(e[w+3]<128||b>250&&S>250&&k>250)};let i=null;for(let f=0;f<o;f++){for(let h=0;h<r;h++)if(a(h,f)){i={x:h,y:f};break}if(i)break}if(!i)return null;const n=[];let l=i,d=6;const p=[{x:1,y:0},{x:1,y:-1},{x:0,y:-1},{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1}];do{n.push({x:l.x,y:l.y});let f=(d+5)%8,h=null,w=!1;for(let b=0;b<8;b++){const S=p[f],k={x:l.x+S.x,y:l.y+S.y};if(a(k.x,k.y)){h=k,d=f,w=!0;break}f=(f+1)%8}if(!w)break;l=h}while(l.x!==i.x||l.y!==i.y);return n}function Ae(t,e,r){const o=r.x-e.x,a=r.y-e.y;if(o===0&&a===0)return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));const i=Math.abs(a*t.x-o*t.y+r.x*e.y-r.y*e.x),n=Math.sqrt(o*o+a*a);return i/n}function re(t,e){let r=0,o=0;const a=t.length-1;for(let i=1;i<a;i++){const n=Ae(t[i],t[0],t[a]);n>r&&(o=i,r=n)}if(r>e){const i=re(t.slice(0,o+1),e),n=re(t.slice(o,a+1),e);return i.slice(0,i.length-1).concat(n)}else return[t[0],t[a]]}function qe(t,e=1){return t.length<3?t:re(t,e)}
