(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const d of a.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&r(d)}).observe(document,{childList:!0,subtree:!0});function n(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(i){if(i.ep)return;i.ep=!0;const a=n(i);fetch(i.href,a)}})();const M="sandbox-sq0idb-nbW_Oje9Dm0L5YvQ7WP2ow",U="LTS82DEX24XR0",Q="http://localhost:3000";let $,q,m=null,o,s,F,z,R,v,O,p,y,g,B,f,C,T,E,k,L,S,I,b,x,D,N,P=0;async function A(){if(o=document.getElementById("imageCanvas"),!o){console.error("FATAL: imageCanvas element not found. Aborting BootStrap.");const t=document.querySelector("body");if(t){const e=document.createElement("div");e.textContent="Critical error: Image canvas not found. Please refresh or contact support.",e.style.color="red",e.style.padding="20px",e.style.textAlign="center",t.prepend(e)}return}s=o.getContext("2d"),F=document.getElementById("textInput"),z=document.getElementById("textSizeInput"),R=document.getElementById("textColorInput"),v=document.getElementById("addTextBtn"),O=document.getElementById("textFontFamily"),p=document.getElementById("stickerMaterial"),y=document.getElementById("designMarginNote"),g=document.getElementById("stickerQuantity"),B=document.getElementById("calculatedPriceDisplay"),f=document.getElementById("payment-status-container"),C=document.getElementById("ipfsLinkContainer"),T=document.getElementById("file"),k=document.getElementById("fileNameDisplay"),E=document.getElementById("payment-form"),L=document.getElementById("rotateLeftBtn"),S=document.getElementById("rotateRightBtn"),I=document.getElementById("resizeInput"),b=document.getElementById("resizeBtn"),x=document.getElementById("startCropBtn"),D=document.getElementById("grayscaleBtn"),N=document.getElementById("sepiaBtn"),console.log(`[CLIENT] Initializing Square SDK with appId: ${M}, locationId: ${U}`);try{if(!window.Square||!window.Square.payments)throw new Error("Square SDK is not loaded.");$=window.Square.payments(M,U),q=await X($)}catch(t){c(`Failed to initialize payments: ${t.message}`,"error"),console.error("[CLIENT] Failed to initialize Square payments SDK:",t);return}g&&(w(),g.addEventListener("input",w),g.addEventListener("change",w)),p&&p.addEventListener("change",w),v&&v.addEventListener("click",V),L&&L.addEventListener("click",()=>W(-90)),S&&S.addEventListener("click",()=>W(90)),D&&D.addEventListener("click",Z),N&&N.addEventListener("click",ee),b&&b.addEventListener("click",te),x&&x.addEventListener("click",ne),T&&T.addEventListener("change",Y),console.log("[CLIENT] BootStrap: Checking paymentFormGlobalRef before attaching listener. paymentFormGlobalRef:",E),E?(console.log("[CLIENT] BootStrap: paymentFormGlobalRef found. Attaching submit event listener."),E.addEventListener("submit",j)):(console.error("[CLIENT] BootStrap: Payment form with ID 'payment-form' not found. Payments will not work."),c("Payment form is missing. Cannot process payments.","error")),G(!m),y&&(y.style.display="none")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",A):A();function J(t,e){if(t<=0)return 0;let n;t<50?n=80:t<100?n=70:t<250?n=60:t<500?n=50:n=40;let r=1;return e==="pvc_laminated"&&(r=1.5),Math.round(t*n*r)}function w(){const t=p?p.value:"pp_standard";if(g&&B){const e=parseInt(g.value,10);if(isNaN(e)||e<0){P=0,B.textContent=e<0?"Invalid Quantity":H(0);return}P=J(e,t),B.textContent=H(P)}}function H(t){return(t/100).toLocaleString("en-US",{style:"currency",currency:"USD"})}async function X(t){if(!t)throw new Error("Payments SDK not ready for card initialization.");const e=await t.card();return await e.attach("#card-container"),e}async function _(t){if(!t)throw new Error("Card payment method not initialized.");const e=await t.tokenize();if(e.status==="OK"){if(!e.token)throw new Error("Tokenization succeeded but no token was returned.");return e.token}let n=`Tokenization failed: ${e.status}`;throw e.errors&&(n+=` ${JSON.stringify(e.errors)}`),new Error(n)}async function j(t){var e,n;if(console.log("[CLIENT] handlePaymentFormSubmit triggered."),t.preventDefault(),c("Processing order...","info"),!m){c("Please upload a sticker design image before submitting.","error");return}try{c("Tokenizing card...","info"),console.log("[CLIENT] Tokenizing card.");const r=await _(q);console.log("[CLIENT] Tokenization successful. Nonce (sourceId):",r);const i=await new Promise(K=>o.toBlob(K,"image/png"));if(!i)throw new Error("Could not get image data from canvas.");const a=new FormData,d={quantity:g?parseInt(g.value,10):0,material:p?p.value:"unknown",cutLineFileName:((n=(e=document.getElementById("cutLineFile"))==null?void 0:e.files[0])==null?void 0:n.name)||null},l={givenName:document.getElementById("firstName").value||void 0,familyName:document.getElementById("lastName").value||void 0,email:document.getElementById("email").value||void 0,phone:document.getElementById("phone").value||void 0,addressLines:[document.getElementById("address").value||""],city:document.getElementById("city").value||void 0,state:document.getElementById("state").value||void 0,postalCode:document.getElementById("postalCode").value||void 0,countryCode:"US"};a.append("designImage",i,"design.png"),a.append("sourceId",r),a.append("amountCents",P),a.append("currency","USD"),a.append("orderDetails",JSON.stringify(d)),a.append("billingContact",JSON.stringify(l)),c("Submitting order to server...","info"),console.log("[CLIENT] Submitting order to server at /api/create-order");const u=await fetch(`${Q}/api/create-order`,{method:"POST",body:a}),h=await u.json();if(!u.ok)throw new Error(h.error||"Failed to create order on server.");console.log("[CLIENT] Order created successfully on server:",h),c(`Order successfully placed! Order ID: ${h.order.orderId.substring(0,8)}...`,"success"),h.order.designIpfsHash&&C&&(C.innerHTML=`Design IPFS Hash: ${h.order.designIpfsHash}`,C.style.visibility="visible")}catch(r){console.error("[CLIENT] Error during payment form submission:",r),c(`Error: ${r.message}`,"error")}}function c(t,e="info"){if(!f){console.error("Payment status container not found. Message:",t);return}f.textContent=t,f.style.visibility="visible",f.classList.remove("payment-success","payment-error","payment-info"),e==="success"?f.classList.add("payment-success"):e==="error"?f.classList.add("payment-error"):f.classList.add("payment-info")}function G(t){const e=[L,S,b,x,D,N,I,F,z,R,v,O],n=["opacity-50","cursor-not-allowed"];e.forEach(r=>{r&&(r.disabled=t,t?r.classList.add(...n):r.classList.remove(...n))}),y&&(y.style.display=t?"none":"block")}function Y(t){const e=t.target.files[0];if(!e||!e.type.startsWith("image/")){c("Invalid file type. Please select an image.","error");return}k&&(k.textContent=e.name);const n=new FileReader;n.onload=()=>{const r=new Image;r.onload=()=>{m=r,G(!1),c("Image loaded successfully.","success");const i=500,a=400;let d=r.width,l=r.height;if(d>i){const u=i/d;d=i,l*=u}if(l>a){const u=a/l;l=a,d*=u}o&&s&&(o.width=d,o.height=l,s.clearRect(0,0,o.width,o.height),s.drawImage(m,0,0,o.width,o.height))},r.onerror=()=>c("Error loading image data.","error"),r.src=n.result},n.onerror=()=>c("Error reading file.","error"),n.readAsDataURL(e)}function V(){if(!o||!s||!m){c("Please load an image before adding text.","error");return}const t=F.value,e=parseInt(z.value,10),n=R.value,r=O.value;if(!t.trim()||isNaN(e)||e<=0){c("Please enter valid text and size.","error");return}s.font=`${e}px ${r}`,s.fillStyle=n,s.textAlign="center",s.textBaseline="middle",s.fillText(t,o.width/2,o.height/2),c(`Text "${t}" added.`,"success")}function W(t){if(!o||!s||!m)return;const e=document.createElement("canvas"),n=e.getContext("2d"),r=o.toDataURL(),i=new Image;i.onload=()=>{const a=o.width,d=o.height,l=t===90||t===-90?d:a,u=t===90||t===-90?a:d;e.width=l,e.height=u,n.translate(l/2,u/2),n.rotate(t*Math.PI/180),n.drawImage(i,-a/2,-d/2,a,d),o.width=l,o.height=u,s.clearRect(0,0,o.width,o.height),s.drawImage(e,0,0)},i.src=r}function Z(){if(!o||!s||!m)return;const t=s.getImageData(0,0,o.width,o.height),e=t.data;for(let n=0;n<e.length;n+=4){const r=(e[n]+e[n+1]+e[n+2])/3;e[n]=r,e[n+1]=r,e[n+2]=r}s.putImageData(t,0,0)}function ee(){if(!o||!s||!m)return;const t=s.getImageData(0,0,o.width,o.height),e=t.data;for(let n=0;n<e.length;n+=4){const r=e[n],i=e[n+1],a=e[n+2];e[n]=Math.min(255,r*.393+i*.769+a*.189),e[n+1]=Math.min(255,r*.349+i*.686+a*.168),e[n+2]=Math.min(255,r*.272+i*.534+a*.131)}s.putImageData(t,0,0)}function te(){if(!o||!s||!m)return;const t=o.toDataURL(),e=new Image;e.onload=()=>{const n=I.value;if(!n.endsWith("%"))return;const r=parseFloat(n.replace("%",""));if(isNaN(r)||r<=0)return;const i=e.width*(r/100),a=e.height*(r/100);o.width=i,o.height=a,s.clearRect(0,0,o.width,o.height),s.drawImage(e,0,0,i,a),I&&(I.value="")},e.src=t}function ne(){if(!o||!s||!m)return;const t=o.toDataURL(),e=new Image;e.onload=()=>{const n=e.width/2,r=e.height/2,i=e.width/4,a=e.height/4;o.width=n,o.height=r,s.clearRect(0,0,o.width,o.height),s.drawImage(e,i,a,n,r,0,0,o.width,o.height)},e.src=t}
