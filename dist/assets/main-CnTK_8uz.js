import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css               *//* empty css                      */const j="sandbox-sq0idb-tawTw_Vl7VGYI6CZfKEshA",H="LTS82DEX24XR0",L="http://localhost:3000";let X,Y,p,u=null,o,a,$,U,M,k,O,h,y,g,B,m,R,v,z,S,b,w,T,x,D,F,I=0;async function ne(){if(o=document.getElementById("imageCanvas"),!o){console.error("FATAL: imageCanvas element not found. Aborting BootStrap.");const t=document.querySelector("body");if(t){const e=document.createElement("div");e.textContent="Critical error: Image canvas not found. Please refresh or contact support.",e.style.color="red",e.style.padding="20px",e.style.textAlign="center",t.prepend(e)}return}a=o.getContext("2d"),$=document.getElementById("textInput"),U=document.getElementById("textSizeInput"),M=document.getElementById("textColorInput"),k=document.getElementById("addTextBtn"),O=document.getElementById("textFontFamily"),h=document.getElementById("stickerMaterial"),y=document.getElementById("designMarginNote"),g=document.getElementById("stickerQuantity"),B=document.getElementById("calculatedPriceDisplay"),m=document.getElementById("payment-status-container"),document.getElementById("ipfsLinkContainer"),R=document.getElementById("file"),z=document.getElementById("fileNameDisplay"),v=document.getElementById("payment-form"),S=document.getElementById("rotateLeftBtn"),b=document.getElementById("rotateRightBtn"),w=document.getElementById("resizeInput"),T=document.getElementById("resizeBtn"),x=document.getElementById("startCropBtn"),D=document.getElementById("grayscaleBtn"),F=document.getElementById("sepiaBtn"),await _(),console.log(`[CLIENT] Initializing Square SDK with appId: ${j}, locationId: ${H}`);try{if(!window.Square||!window.Square.payments)throw new Error("Square SDK is not loaded.");X=window.Square.payments(j,H),Y=await ae(X)}catch(t){s(`Failed to initialize payments: ${t.message}`,"error"),console.error("[CLIENT] Failed to initialize Square payments SDK:",t);return}g&&(C(),g.addEventListener("input",C),g.addEventListener("change",C)),h&&h.addEventListener("change",C),k&&k.addEventListener("click",ce),S&&S.addEventListener("click",()=>Q(-90)),b&&b.addEventListener("click",()=>Q(90)),D&&D.addEventListener("click",le),F&&F.addEventListener("click",ue),T&&T.addEventListener("click",me),x&&x.addEventListener("click",ge),R&&R.addEventListener("change",de),o&&(o.addEventListener("dragover",t=>{t.preventDefault(),o.classList.add("border-dashed","border-2","border-blue-500")}),o.addEventListener("dragleave",t=>{t.preventDefault(),o.classList.remove("border-dashed","border-2","border-blue-500")}),o.addEventListener("drop",t=>{t.preventDefault(),o.classList.remove("border-dashed","border-2","border-blue-500");const e=t.dataTransfer.files[0];e&&A(e)})),window.addEventListener("paste",t=>{const e=(t.clipboardData||t.originalEvent.clipboardData).items;for(const n of e)if(n.kind==="file"){const r=n.getAsFile();r&&A(r)}}),console.log("[CLIENT] BootStrap: Checking paymentFormGlobalRef before attaching listener. paymentFormGlobalRef:",v),v?(console.log("[CLIENT] BootStrap: paymentFormGlobalRef found. Attaching submit event listener."),v.addEventListener("submit",se)):(console.error("[CLIENT] BootStrap: Payment form with ID 'payment-form' not found. Payments will not work."),s("Payment form is missing. Cannot process payments.","error")),V(!u),y&&(y.style.display="none")}document.addEventListener("DOMContentLoaded",()=>{ne(),setTimeout(()=>{typeof Square>"u"&&(console.error("[CLIENT] Square SDK appears to be blocked."),oe())},2e3)});function oe(){const t=document.getElementById("adblock-warning");t&&(t.style.display="block")}function re(t,e){if(t<=0)return 0;let n;t<50?n=80:t<100?n=70:t<250?n=60:t<500?n=50:n=40;let r=1;return e==="pvc_laminated"&&(r=1.5),Math.round(t*n*r)}function C(){const t=h?h.value:"pp_standard";if(g&&B){const e=parseInt(g.value,10);if(isNaN(e)||e<0){I=0,B.textContent=e<0?"Invalid Quantity":J(0);return}I=re(e,t),B.textContent=J(I)}}function J(t){return(t/100).toLocaleString("en-US",{style:"currency",currency:"USD"})}async function ae(t){if(!t)throw new Error("Payments SDK not ready for card initialization.");const e=await t.card();return await e.attach("#card-container"),e}async function ie(t,e){if(!t)throw new Error("Card payment method not initialized.");const n=await t.tokenize(e);if(n.status==="OK"){if(!n.token)throw new Error("Tokenization succeeded but no token was returned.");return n.token}let r=`Tokenization failed: ${n.status}`;throw n.errors&&(r+=` ${JSON.stringify(n.errors)}`),new Error(r)}async function _(){try{const t=await fetch(`${L}/api/csrf-token`,{credentials:"include"});if(!t.ok)throw new Error(`Server responded with ${t.status}`);const e=await t.json();if(!e.csrfToken)throw new Error("CSRF token not found in server response");p=e.csrfToken,console.log("[CLIENT] CSRF Token fetched and stored.")}catch(t){console.error("[CLIENT] Error fetching CSRF token:",t),s("A security token could not be loaded. Please refresh the page to continue.","error")}}async function se(t){if(console.log("[CLIENT] handlePaymentFormSubmit triggered."),t.preventDefault(),s("Processing order...","info"),!u){s("Please upload a sticker design image before submitting.","error");return}if(!p){s("Cannot submit form. A required security token is missing. Please refresh the page.","error"),console.error("[CLIENT] Aborting submission: CSRF token is missing.");return}const e=document.getElementById("email").value;if(!e){s("Please enter an email address to proceed.","error");return}try{s("Issuing temporary auth token...","info");const n=await fetch(`${L}/api/auth/issue-temp-token`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-CSRF-Token":p},body:JSON.stringify({email:e})});if(!n.ok){const P=await n.text();throw new Error(`Could not issue a temporary authentication token. Server responded with: ${P}`)}const{token:r}=await n.json();if(!r)throw new Error("Temporary authentication token was not received.");console.log("[CLIENT] Temporary auth token received.");const d=await new Promise(P=>o.toBlob(P,"image/png"));if(!d)throw new Error("Could not get image data from canvas.");s("Uploading design...","info");const i=new FormData;i.append("designImage",d,"design.png");const c=document.getElementById("cutLineFile");c&&c.files[0]&&i.append("cutLineFile",c.files[0]);const l=await fetch(`${L}/api/upload-design`,{method:"POST",credentials:"include",headers:{Authorization:`Bearer ${r}`,"X-CSRF-Token":p},body:i}),f=await l.json();if(!l.ok)throw new Error(f.error||"Failed to upload design.");const q=f.designImagePath,N=f.cutLinePath;console.log("[CLIENT] Design uploaded. Path:",q),N&&console.log("[CLIENT] Cut line uploaded. Path:",N);const G={givenName:document.getElementById("firstName").value,familyName:document.getElementById("lastName").value,email:document.getElementById("email").value,phone:document.getElementById("phone").value,addressLines:[document.getElementById("address").value],city:document.getElementById("city").value,state:document.getElementById("state").value,postalCode:document.getElementById("postalCode").value,countryCode:"US"},Z={amount:(I/100).toFixed(2),currencyCode:"USD",intent:"CHARGE",billingContact:G,customerInitiated:!0,sellerKeyedIn:!1};s("Securing card details...","info"),console.log("[CLIENT] Tokenizing card with verification details.");const W=await ie(Y,Z);console.log("[CLIENT] Tokenization successful. Nonce (sourceId):",W);const ee={quantity:g?parseInt(g.value,10):0,material:h?h.value:"unknown",cutLinePath:N},te={sourceId:W,amountCents:I,currency:"USD",designImagePath:q,orderDetails:ee,billingContact:G};s("Submitting order to server...","info"),console.log("[CLIENT] Submitting order to server at /api/create-order");const K=await fetch(`${L}/api/create-order`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`,"X-CSRF-Token":p},body:JSON.stringify(te)}),E=await K.json();if(!K.ok)throw E.error&&E.error.includes("csrf")&&(s("Your security token has expired. Please try submitting again.","error"),console.warn("[CLIENT] CSRF token was invalid. Fetching a new one."),await _()),new Error(E.error||"Failed to create order on server.");console.log("[CLIENT] Order created successfully on server:",E),s("Order successfully placed! Redirecting to your order history...","success"),setTimeout(()=>{window.location.href=`/orders.html?token=${r}`},2e3)}catch(n){console.error("[CLIENT] Error during payment form submission:",n),s(`Error: ${n.message}`,"error")}}function s(t,e="info"){if(!m){console.error("Payment status container not found. Message:",t);return}m.textContent=t,m.style.visibility="visible",m.classList.remove("payment-success","payment-error","payment-info"),e==="success"?m.classList.add("payment-success"):e==="error"?m.classList.add("payment-error"):m.classList.add("payment-info")}function V(t){const e=[S,b,T,x,D,F,w,$,U,M,k,O],n=["opacity-50","cursor-not-allowed"];e.forEach(r=>{r&&(r.disabled=t,t?r.classList.add(...n):r.classList.remove(...n))}),y&&(y.style.display=t?"none":"block")}function de(t){const e=t.target.files[0];e&&A(e)}function A(t){if(!t||!t.type.startsWith("image/")){s("Invalid file type. Please select an image.","error");return}z&&(z.textContent=t.name);const e=new FileReader;e.onload=()=>{const n=new Image;n.onload=()=>{u=n,V(!1),s("Image loaded successfully.","success");const r=500,d=400;let i=n.width,c=n.height;if(i>r){const l=r/i;i=r,c*=l}if(c>d){const l=d/c;c=d,i*=l}o&&a&&(o.width=i,o.height=c,a.clearRect(0,0,o.width,o.height),a.drawImage(u,0,0,o.width,o.height))},n.onerror=()=>s("Error loading image data.","error"),n.src=e.result},e.onerror=()=>s("Error reading file.","error"),e.readAsDataURL(t)}function ce(){if(!o||!a||!u){s("Please load an image before adding text.","error");return}const t=$.value,e=parseInt(U.value,10),n=M.value,r=O.value;if(!t.trim()||isNaN(e)||e<=0){s("Please enter valid text and size.","error");return}a.font=`${e}px ${r}`,a.fillStyle=n,a.textAlign="center",a.textBaseline="middle",a.fillText(t,o.width/2,o.height/2),s(`Text "${t}" added.`,"success")}function Q(t){if(!o||!a||!u)return;const e=document.createElement("canvas"),n=e.getContext("2d"),r=o.toDataURL(),d=new Image;d.onload=()=>{const i=o.width,c=o.height,l=t===90||t===-90?c:i,f=t===90||t===-90?i:c;e.width=l,e.height=f,n.translate(l/2,f/2),n.rotate(t*Math.PI/180),n.drawImage(d,-i/2,-c/2,i,c),o.width=l,o.height=f,a.clearRect(0,0,o.width,o.height),a.drawImage(e,0,0)},d.src=r}function le(){if(!o||!a||!u)return;const t=a.getImageData(0,0,o.width,o.height),e=t.data;for(let n=0;n<e.length;n+=4){const r=(e[n]+e[n+1]+e[n+2])/3;e[n]=r,e[n+1]=r,e[n+2]=r}a.putImageData(t,0,0)}function ue(){if(!o||!a||!u)return;const t=a.getImageData(0,0,o.width,o.height),e=t.data;for(let n=0;n<e.length;n+=4){const r=e[n],d=e[n+1],i=e[n+2];e[n]=Math.min(255,r*.393+d*.769+i*.189),e[n+1]=Math.min(255,r*.349+d*.686+i*.168),e[n+2]=Math.min(255,r*.272+d*.534+i*.131)}a.putImageData(t,0,0)}function me(){if(!o||!a||!u)return;const t=o.toDataURL(),e=new Image;e.onload=()=>{const n=w.value;if(!n.endsWith("%"))return;const r=parseFloat(n.replace("%",""));if(isNaN(r)||r<=0)return;const d=e.width*(r/100),i=e.height*(r/100);o.width=d,o.height=i,a.clearRect(0,0,o.width,o.height),a.drawImage(e,0,0,d,i),w&&(w.value="")},e.src=t}function ge(){if(!o||!a||!u)return;const t=o.toDataURL(),e=new Image;e.onload=()=>{const n=e.width/2,r=e.height/2,d=e.width/4,i=e.height/4;o.width=n,o.height=r,a.clearRect(0,0,o.width,o.height),a.drawImage(e,d,i,n,r,0,0,o.width,o.height)},e.src=t}
